 <?php header("Access-Control-Allow-Origin: https://github.com"); ?>
 
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title> Cube generator  </title>
<script src="jquery-3.3.1.min.js"></script>
 <script>
 
 // TODO: Make hover-over on cards to show the list of associated commanders
 // TODO; Make a drop-down list of commanders to highlight their associated cards
 var colors          = ["W",  "U", "B", "R", "G", []];
 var contents = [];
(function($) {
	$.fn.innerText = function(msg) {
		if (msg) {
			if (document.body.innerText) {
				for (var i in this) {
					this[i].innerText = msg;
				}
			} else {
				for (var i in this) {
					this[i].innerHTML.replace(/&amp;lt;br&amp;gt;/gi, "n").replace(/(&amp;lt;([^&amp;gt;]+)&amp;gt;)/gi, "");
				}
			}
			return this;
		} else {
			if (document.body.innerText) {
				return this[0].innerText;
			} else {
				return this[0].innerHTML.replace(/&amp;lt;br&amp;gt;/gi, "n").replace(/(&amp;lt;([^&amp;gt;]+)&amp;gt;)/gi, "");
			}
		}
	};
})(jQuery);

function isItemInArray(array, item) {
    for (var i = 0; i < array.length; i++) {
        // This if statement depends on the format of your array
        if (array[i][0] == item[0] && array[i][1] == item[1]) {
            return i;   // Found it
        }
    }
    return -1;   // Not found
}

function guild_cidx_to_int(cidx){
    if (cidx[0] == 'U' && cidx[1] == 'W'){
            return 0
    }

    if (cidx[0] == 'B' && cidx[1] == 'U'){
            return 1
    }

    if (cidx[0] == 'B' && cidx[1] =='R'){
            return 2
    }

    if (cidx[0] == 'G' && cidx[1] =='R'){
            return 3
    }

    if (cidx[0] == 'G' && cidx[1] =='W'){
            return 4
    }

    if (cidx[0] == 'B' && cidx[1] =='W'){
            return 5
    }

    if (cidx[0] == 'R' && cidx[1] =='U'){
            return 6
    }

    if (cidx[0] == 'B' && cidx[1] =='G'){
            return 7
    }

    if (cidx[0] == 'R' && cidx[1] =='W'){
            return 8
    }

    if (cidx[0] == 'G' && cidx[1] == 'U'){
            return 9
    }
}

function sortByKey(array, key) {
    return array.sort(function(a, b) {
        var x = a[key];
        var y = b[key];

        if (typeof x == "string")
        {
            x = (""+x).toLowerCase(); 
        }
        if (typeof y == "string")
        {
            y = (""+y).toLowerCase();
        }

        return ((x < y) ? 1 : ((x > y) ? -1 : 0));
    });
}

arrSum = function(arr){
  return arr.reduce(function(a,b){
    return a + b
  }, 0);
}

function deterministic_cube(dicts){
	cube_creatures = []
    cube_noncreatures  = []
    found_creatures_by_color = [0, 0, 0, 0, 0, 0]
    found_noncreatures_by_color = [0, 0, 0, 0, 0, 0]
    
    // TODO: Include guild cards
    found_cards_guilds = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    
    cubesize = $('#cubesize').val()
    bsize=cubesize/12
	ncreatures = [bsize, bsize, bsize, bsize, bsize, bsize]
	max_creatures = arrSum(ncreatures)
	nspells =    [bsize, bsize, bsize, bsize, bsize, bsize]
	max_noncreatures = arrSum(nspells)
	mincounts = 1

	cards_from_each_guild = 1
	cube_size = cubesize - cards_from_each_guild*10
    multicolor = cards_from_each_guild
    lands      = false
    
    score_dicts2 = []
    for (var i = 0; i < Object.keys(score_dicts).length; i++){
    	tmp_dict = score_dicts[Object.keys(score_dicts)[i]]
    	tmp_dict["name"] = Object.keys(score_dicts)[i].replace("\"", "").trim()
    	score_dicts2.push(tmp_dict)
    }
    score_dicts = score_dicts2
    console.log("sorted:", score_dicts)
    if($('#choice1').is(':checked')){focus="score"}
    if($('#choice2').is(':checked')){focus="counts"}
    ordered_dicts = sortByKey(score_dicts, focus)
    //console.log("the length", ordered_dicts.length)
    for (var i = 0; i < ordered_dicts.length; i++){
		card = ordered_dicts[i]
		try{types = json_data["data"][card["name"]][0]["types"]}
		catch(error){
		console.log("problem with", card)
		continue}
		cid = json_data["data"][card["name"]][0]["colorIdentity"]
		//console.log("ding dong", i, card, types, cid)
		
		if (types.includes("Land")){continue}
		
		// if: we want to add the card to the cube
		if (card["counts"] >= mincounts){
		
			// first handle the monocolored cards
			if (cid.length <= 1){
				if (cid.length == 1){
					cidx = colors.indexOf(cid[0])
				} else {
					cidx = 5
				}

				if (types.includes("Creature")){
					if (found_creatures_by_color[cidx] < ncreatures[cidx]){
						cube_creatures.push(card)
						found_creatures_by_color[cidx] += 1
					}
				}
				else {
					if (found_noncreatures_by_color[cidx] < nspells[cidx]){
						cube_noncreatures.push(card)
						found_noncreatures_by_color[cidx] += 1
					}
				}
			}
		}

    	if (i>3000 || arrSum(found_creatures_by_color) == max_creatures && arrSum(found_noncreatures_by_color) == max_noncreatures){
    		console.log("breaking")
    		break
    	}
    	
    	
    }
    console.log(ordered_dicts)
    console.log("kickstart", cube_creatures, cube_noncreatures)
    console.log("distribution", found_creatures_by_color, found_noncreatures_by_color)
    return cube_creatures.concat(cube_noncreatures)
}

    
    
function gather_all_cards_relevant_to_commanders2(contents){
    score_dicts2 = {}
    for (var k = 0; k < contents.length; k++){
    	con1 = contents[k]
        for (var k2 = 0; k2 < con1["cards"].length; k2++) {
        	card1 = con1["cards"][k2]
            try{card1["name"] in score_dicts2}
            catch(error){continue}
            if (card1["name"] in score_dicts2){

                score_dicts2[card1["name"]]["counts"] +=1
                score_dicts2[card1["name"]]["score"] += card1["cond_prob"]
                if (card1["cond_prob"] > score_dicts2[card1["name"]]["max_score"]){
                	score_dicts2[card1["name"]]["max_score"] = card1["cond_prob"]
                }
                score_dicts2[card1["name"]]["commanders"].push(con1["cname"])
                
            }
            else{
                score_dicts2[card1["name"]] = {}
                score_dicts2[card1["name"]]["score"] = card1["cond_prob"]
                score_dicts2[card1["name"]]["budget"] = card1["budget"]
                score_dicts2[card1["name"]]["max_score"] = card1["cond_prob"]
                score_dicts2[card1["name"]]["counts"] = 1
                score_dicts2[card1["name"]]["commanders"] = [con1["cname"]]
                
            }
        }
    }
    return score_dicts2
}




var json_data;
$(document).ready(function() {
	$.getJSON('json_data.json', function(data) {
		json_data = data; // JSON result in `data` variable
	});
	//  ^------last argument
});



var message; 
var full_cube;

$.ajaxSetup({
    async: false
});

$(document).ready(function() {

	$('#select-id').on('change', function (e) {
		var optionSelected = $("option:selected", this);
		var valueSelected = this.value;
		console.log(valueSelected)
		$("div").removeClass('thick');
   	     $("."+valueSelected).addClass('thick');
	});

	$("#cat").click(function() {
		contents = [];
		var message = $('#catmessage').val();

		a = message.split("\n")

		for (let i = 0; i < a.length; i++){
			a[i] = a[i].replaceAll('\'', '')
			a[i] = a[i].replaceAll(',', '')
			a[i] = a[i].replaceAll("\\n", "")
			a[i] = a[i].toLowerCase().trim().replaceAll(" ", "-")
			// XXX: Not everyone is in "cleaned_cardlists" yet, do this offline
			$.getJSON("cubed/cleaned_cardlists/"+ a[i] + ".json", function(data){
				contents.push(JSON.parse(data));
			}).fail(function(error){
				console.log("An error has occurred.", i, a[i], error);
			});
		}

		console.log("hayayay", contents.length)
		score_dicts = gather_all_cards_relevant_to_commanders2(contents)
		console.log("uwu whats this", score_dicts)
		// make the cube list
		full_cube = deterministic_cube(score_dicts)
		
		// reset the table
		$('.tg-0lax').text("");
		
		// populate the table with the cube cards
		for (var i = 0; i < full_cube.length; i++){
			card = full_cube[i]["name"]
			if(card !== null && card !== '') {
				cid2 = json_data["data"][$.trim(card)][0]["colorIdentity"]
				types = json_data["data"][$.trim(card)][0]["types"]
				if (types.includes("Creature")){
				    bigtype = "creatures"
				} else {
				    bigtype = "noncreatures"
				}
				
				if (cid2.length > 1){
					cid_tag="multicolored"
				} else if (cid2.length == 0){
					cid_tag="colorless"
				} else {
					cid_tag = cid2[0]
				}
				console.log(full_cube[i]["commanders"])
				$("#"+String(bigtype)+"_"+String(cid_tag)).append($('<div></div>').addClass(full_cube[i]["commanders"]).addClass("tooltip").text(String(card)).append($("<span class=\"tooltiptext\"></span>").html(full_cube[i]["commanders"].join(("<br>"))))).append("<br>")

			}	
			
		}
		
		// populate select item with commander names
		
		for (var j = 0; j < contents.length; j++){
			cname = String(contents[j]["cname"])
			console.log("hmm", cname)
			$('#select-id').append($('<option></option>').val(cname).text(cname)); 
		}

	});
});



</script>
</head>
<body>
 
 <div class="demo">
<p> Commanders: </p>
  <textarea id="catmessage" rows="10" cols="30">Liesa, Shroud of Dusk
Teysa Karlov
Meren of Clan Nel Toth
Dina, Soul Steeper
Feather, the Redeemed
Firesong and Sunspeaker
Brudiclad, Telchor Engineer
Mizzix of the Izmagnus
Tatyova, Benthic Druid
Esix, Fractal Bloom</textarea>
  
  <p>Focus on:</p>
  <input type="radio" id="choice1" name="focus" value="" checked="checked">
  <label for="choice1" >Archetypes</label><br>
  <input type="radio" id="choice2" name="focus">
  <label for="choice2">Goodstuff</label><br>  
  
  <label for="cubesize">Cube size (60-900):</label>

<input type="number" id="cubesize"
       min="60" max="900" value="120">

  
  <input id="cat" type="submit" value="Make cube">
<br>   
</div>
 
 <style type="text/css">
 
 .thick {
  font-weight: bold;
}
 
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-0lax{text-align:left;vertical-align:top}
</style>

  <p>Cube list:</p>

<table class="tg">
<thead>
  <tr>
    <th class="tg-0lax"></th>
    <th class="tg-0la">White</th>
    <th class="tg-0la">Blue</th>
    <th class="tg-0la">Black</th>
    <th class="tg-0la">Red</th>
    <th class="tg-0la">Green</th>
    <th class="tg-0la">Multicolored</th>
    <th class="tg-0la">Colorless</th>
    <th class="tg-0la">Lands</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0la">Creatures</td>
    <td class="tg-0lax" id="creatures_W"></td>
    <td class="tg-0lax" id="creatures_U"></td>
    <td class="tg-0lax" id="creatures_B"></td>
    <td class="tg-0lax" id="creatures_R"></td>
    <td class="tg-0lax" id="creatures_G"></td>
    <td class="tg-0lax" id="creatures_multicolored"></td>
    <td class="tg-0lax" id="creatures_colorless"></td>
    <td class="tg-0lax" id="creatures_lands"></td>
  </tr>
  <tr>
    <td class="tg-0la">Noncreatures</td>
    <td class="tg-0lax" id="noncreatures_W"></td>
    <td class="tg-0lax" id="noncreatures_U"></td>
    <td class="tg-0lax" id="noncreatures_B"></td>
    <td class="tg-0lax" id="noncreatures_R"></td>
    <td class="tg-0lax" id="noncreatures_G"></td>
    <td class="tg-0lax" id="noncreatures_multicolored"></td>
    <td class="tg-0lax" id="noncreatures_colorless"></td>
    <td class="tg-0lax" id="noncreatures_lands"></td>
  </tr>
</tbody>
</table>

<br>



  <label for="cars">Highlight cards associated with: </label>
  <select name="cars" id="select-id">
      <option value="nocommanders">Any</option>

  </select>

<br><br>

<style>
/* Tooltip container */
.tooltip {

  display: inline-block;

}

/* Tooltip text */
.tooltip .tooltiptext {
  visibility: hidden;
  width: auto;
  background-color: black;
  color: #fff;
  text-align: center;
  padding: 7px;
  border-radius: 6px;
  z-index: 1000;	
 
  /* Position the tooltip text - see examples below! */
  position: absolute;
  z-index: 10000	;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
  visibility: visible;
  z-index: 1000;
}
</style>





</body>
</html>
